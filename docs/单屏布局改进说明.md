# 单屏布局改进说明

## 改进概述

根据需求对单屏布局进行了以下改进：

### 1. 视频流布局调整

**改动内容：**
- 中间区域从3D机器人视图改为主控视频视角
- 3D机器人以叠加层形式显示在主控视频左上角（300x220像素）
- 3D机器人有半透明背景和边框，与视频形成层次感

**文件修改：**
- `frontend/src/layouts/SingleScreenLayout.tsx`
- `frontend/src/layouts/SingleScreenLayout.css`

**效果：**
```
┌──────────┬──────────────────────┬──────────┐
│          │  主控视频（带3D叠加） │          │
│  左臂视角 │  ┌──────┐           │  右臂视角 │
│          │  │ 3D   │           │          │
│          │  │机器人│           │          │
└──────────┴──┴──────┴───────────┴──────────┘
```

### 2. 视频控制按钮优化

**改动内容：**
- 移除原有的底部控制栏
- 添加遮罩层控制条，鼠标悬停时显示
- 控制条显示在视频底部，带渐变半透明背景
- 包含功能：播放/暂停、截图、全屏、刷新、关闭视频流

**文件修改：**
- `frontend/src/components/shared/VideoPlayer.tsx`
- `frontend/src/components/shared/CompactStyles.css`

**样式特点：**
- 渐变遮罩：从底部黑色到顶部透明
- 按钮效果：半透明背景 + 悬停放大 + 阴影
- 自动隐藏：非悬停状态自动隐藏控制条

### 3. 音频功能增强

**改动内容：**
- 添加麦克风输入支持（enableMicrophone prop）
- 实时显示麦克风音频频谱
- 使用Web Audio API的AnalyserNode进行频谱分析
- 音频条动态响应真实音频输入

**文件修改：**
- `frontend/src/components/shared/AudioPlayer.tsx`
- `frontend/src/components/shared/CompactStyles.css`

**技术实现：**
```typescript
// 创建音频上下文
const audioContext = new AudioContext();
const analyser = audioContext.createAnalyser();
analyser.fftSize = 256;

// 连接麦克风
const source = audioContext.createMediaStreamSource(stream);
source.connect(analyser);

// 实时获取频谱数据
analyser.getByteFrequencyData(dataArray);
```

### 4. 移除外设状态显示

**改动内容：**
- 从下半部分控制区域移除StatusMonitor组件
- 控制按钮区域和音频可视化区域各占50%宽度
- 移除相关导入和依赖

**文件修改：**
- `frontend/src/layouts/SingleScreenLayout.tsx`
- `frontend/src/layouts/SingleScreenLayout.css`

**布局变化：**
```
改进前：[控制按钮 45%] [状态监控 30%] [音频 25%]
改进后：[控制按钮 50%] [音频可视化 50%]
```

### 5. 控制面板简化

**改动内容：**
- 移除运动控制（前进、后退、左转、右转）
- 移除动作控制（挥手、点赞、抬腿等）
- 仅保留基本功能：启动、停止、紧急停止、系统重置
- 增大按钮尺寸，提升可用性

**文件修改：**
- `frontend/src/components/shared/ControlPanel.tsx`

**按钮尺寸：**
- 紧凑模式：60x60像素
- 标准模式：80x80像素
- 图标尺寸：24px（紧凑）/ 32px（标准）

### 6. 机器人背景工业风格

**改动内容：**
- 背景色：从赛博朋克蓝黑(0x0a0a1a)改为工业灰(0x2a2a2a)
- 地板：金属质感，粗糙度0.7，金属度0.3
- 网格：黄黑配色（0xffaa00 / 0x666666）
- 光照：自然白光主光源 + 暖黄色辅助光
- 支柱：灰色金属材质，带工业照明
- 粒子：灰色环境灰尘效果

**文件修改：**
- `frontend/src/components/shared/Robot3DViewer.tsx`

**色彩方案：**
| 元素 | 改进前 | 改进后 |
|------|--------|--------|
| 背景 | 深蓝黑 (0x0a0a1a) | 工业灰 (0x2a2a2a) |
| 地板 | 深蓝发光 | 灰色金属 |
| 网格 | 青蓝色 | 黄黑色 |
| 主光 | 冷青色 | 自然白光 |
| 辅光 | 洋红色 | 暖黄色 |
| 支柱 | 蓝色发光 | 灰色金属 |
| 粒子 | 青色星空 | 灰色灰尘 |

## 技术要点

### CSS关键样式

1. **3D机器人叠加层**
```css
.robot-3d-overlay {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 20;
  border: 2px solid rgba(16, 185, 129, 0.5);
  border-radius: 8px;
  background: rgba(15, 23, 42, 0.8);
  backdrop-filter: blur(5px);
}
```

2. **视频遮罩控制条**
```css
.video-overlay-controls {
  position: absolute;
  bottom: 0;
  background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.video-container:hover .video-overlay-controls {
  opacity: 1;
}
```

3. **麦克风激活效果**
```css
.streaming-badge.mic-active {
  background: rgba(239, 68, 68, 0.2);
  animation: micPulse 2s infinite;
}
```

### Props接口变化

**AudioPlayer新增：**
```typescript
interface AudioPlayerProps {
  enableMicrophone?: boolean;  // 新增：是否启用麦克风
}
```

## 使用说明

### 1. 启动视频流

- 鼠标悬停到视频区域，底部显示控制条
- 点击播放/暂停按钮控制视频
- 点击关闭按钮停止视频流

### 2. 使用麦克风

- 点击音频可视化区域的麦克风按钮
- 浏览器会请求麦克风权限
- 授权后音频条会实时显示麦克风输入波形

### 3. 查看3D机器人

- 3D机器人显示在主控视频左上角
- 自动旋转背景（机器人保持面向观众）
- 工业风格场景环境

### 4. 控制机器人

- 点击启动按钮启动机器人
- 点击停止按钮停止机器人
- 紧急情况使用紧急停止按钮
- 使用系统重置恢复初始状态

## 响应式适配

### 屏幕宽度 ≤ 1400px
- 左右视角宽度：18%
- 主控视角宽度：64%
- 3D机器人尺寸：250x180像素

### 屏幕宽度 ≤ 1600px
- 视频区域：65%高度
- 控制区域：35%高度

## 注意事项

1. **浏览器兼容性**
   - 麦克风功能需要HTTPS或localhost环境
   - 需要浏览器支持getUserMedia API

2. **性能优化**
   - 3D场景使用较小尺寸减少渲染压力
   - 音频分析使用requestAnimationFrame优化性能

3. **用户体验**
   - 控制条自动隐藏避免遮挡视频
   - 麦克风激活有明显视觉反馈
   - 按钮尺寸增大便于操作

## 待完善功能

1. 麦克风音频回传到后端
2. 视频流切换功能（多个摄像头源）
3. 3D机器人叠加层拖拽调整位置
4. 控制按钮的快捷键支持

## 文件清单

修改的文件：
- `frontend/src/layouts/SingleScreenLayout.tsx`
- `frontend/src/layouts/SingleScreenLayout.css`
- `frontend/src/components/shared/VideoPlayer.tsx`
- `frontend/src/components/shared/AudioPlayer.tsx`
- `frontend/src/components/shared/ControlPanel.tsx`
- `frontend/src/components/shared/Robot3DViewer.tsx`
- `frontend/src/components/shared/CompactStyles.css`

新增的文件：
- `docs/单屏布局改进说明.md`（本文档）

## 测试建议

1. **视频流测试**
   - 测试摄像头连接和断开
   - 测试控制条显示和隐藏
   - 测试各个控制按钮功能

2. **音频测试**
   - 测试麦克风权限请求
   - 测试音频波形显示
   - 测试麦克风开关切换

3. **3D场景测试**
   - 检查3D机器人显示位置
   - 测试工业风格渲染效果
   - 检查自动旋转功能

4. **控制功能测试**
   - 测试基本控制按钮
   - 检查WebSocket通信
   - 测试紧急停止功能
