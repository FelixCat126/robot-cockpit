# 外设控制系统使用指南 (Peripheral Control Guide)
**📝 文档说明：** 详细的外设控制系统使用手册，包括设备连接、配置和使用说明

## 📖 概述

本系统提供了一个灵活、可扩展的外设控制框架，支持通过游戏手柄、摇杆、踏板、键盘等外设控制机器人。

## 🎮 支持的外设类型

### 1. **Gamepad（游戏手柄/摇杆）** ⭐⭐⭐⭐⭐ 推荐
- ✅ Xbox手柄
- ✅ PlayStation手柄
- ✅ 飞行摇杆（Logitech, Thrustmaster等）
- ✅ 方向盘+踏板套装
- ✅ 任何标准HID游戏控制器

**优势：**
- 浏览器原生支持，即插即用
- 高刷新率（60Hz）
- 零配置

### 2. **Keyboard（键盘）** ⭐⭐⭐
- ✅ 作为备用控制方案
- ✅ 开发和调试

### 3. **预留接口**
- 🔌 WebHID API（自定义HID设备）
- 🔌 Web Serial API（串口设备）
- 🔌 WebUSB API（USB设备）

## 🚀 快速开始

### 步骤1：连接外设

1. 将游戏手柄/摇杆通过USB或蓝牙连接到驾驶舱电脑
2. 打开浏览器访问控制台
3. 系统会自动检测并连接外设

### 步骤2：启用外设控制

在`Screen0.tsx`中配置：

```typescript
<ControlPanel 
  screenId={screenId}
  enablePeripherals={true}       // 启用外设控制
  showPeripheralDebug={false}    // 是否显示调试面板
/>
```

### 步骤3：查看外设状态

点击"🎮 显示外设调试"按钮查看实时外设状态：
- 摇杆/轴向的实时值
- 按钮按压状态
- 输入事件日志

## 🎯 当前控制映射

### 游戏手柄控制

| 输入 | 功能 | 说明 |
|------|------|------|
| **左摇杆前推** | 前进 | 速度控制，自动切换行走/奔跑动画 |
| **左摇杆后拉** | 后退 | 反向移动 |
| **左摇杆左右** | 转向 | 可与前进/后退组合 |
| **左摇杆复位** | 停止 | 自动发送停止命令 |
| **A按钮** | 挥手 | Wave 动画 |
| **B按钮** | 点赞 | ThumbsUp 动画 |
| **C按钮** | 跨栏 | WalkJump 动画 |
| **D按钮** | 跳跃 | Jump 动画 |
| **LB按钮** | 左转 | 每次旋转 45° |
| **RB按钮** | 右转 | 每次旋转 45° |

### 键盘控制（备用）

| 按键 | 功能 |
|------|------|
| **W** | 前进 |
| **S** | 后退 |
| **A** | 左转 |
| **D** | 右转 |
| **Space** | 急停 |

## 🔧 自定义输入映射

### 示例：添加自定义控制规则

编辑 `InputMapper.ts` 中的映射规则：

```typescript
// 创建自定义映射器
const mapper = new InputMapper();

// 添加规则：右摇杆Y轴控制机械臂
mapper.addRule({
  id: 'right-stick-arm',
  name: '右摇杆控制机械臂',
  trigger: {
    type: InputEventType.AXIS_CHANGE,
    axisIndex: 3, // 右摇杆Y轴
    threshold: 0.1,
  },
  command: (event: InputEvent) => ({
    type: RobotCommandType.POSITION,
    topic: '/robot/arm/position',
    messageType: 'std_msgs/Float64',
    payload: { data: event.axis?.value || 0 },
    priority: 7,
  }),
});

// 禁用某个规则
mapper.setRuleEnabled('key-w-forward', false);

// 移除规则
mapper.removeRule('button-a-action');
```

### 支持的触发条件

```typescript
{
  type: InputEventType.AXIS_CHANGE,    // 轴向变化
  axisIndex: 0,                        // 轴索引
  threshold: 0.1,                      // 阈值
}

{
  type: InputEventType.BUTTON_DOWN,    // 按钮按下
  buttonIndex: 0,                      // 按钮索引
}

{
  type: InputEventType.KEY_DOWN,       // 键盘按下
  key: 'w',                            // 按键
}
```

## 📊 调试和监控

### 实时状态监控

外设调试面板显示：
1. **设备连接状态** - 绿色（已连接）、黄色（连接中）、红色（断开）
2. **轴向实时值** - 摇杆/踏板的当前值（-1.0 到 +1.0）
3. **按钮状态** - 哪些按钮正在被按下
4. **事件日志** - 最近10条输入事件

### 浏览器控制台日志

```javascript
// 外设管理器日志
[PeripheralManager] 设备已添加: Xbox Controller (gamepad-0)
[PeripheralManager] 所有设备已启动

// 输入映射日志
[InputMapper] 规则已添加: 摇杆控制移动
[InputMapper] 命令已发送: /cmd_vel

// 设备日志
[Gamepad] 已连接: Xbox 360 Controller
[Gamepad] 轴数量: 6
[Gamepad] 按钮数量: 16
```

## 🛠️ 配置选项

### 死区设置

防止摇杆漂移，默认死区为0.15：

```typescript
const gamepad = new GamepadDevice(0, {
  deadzone: 0.15,  // 调整死区（0-1）
});
```

### 采样频率

默认60Hz，可调整：

```typescript
const gamepad = new GamepadDevice(0, {
  sampleRate: 60,  // Hz
});
```

### 按钮防抖

防止按钮误触发，默认300ms：

```typescript
// 在 PeripheralController.tsx 中
const buttonDebounceMs = 300;  // 可调整防抖时间
```

## 📡 通信协议

### WebSocket模式
- 延迟：100-300ms
- 适合：开发调试

### WebRTC模式（推荐生产环境）
- 延迟：< 100ms
- 适合：实时控制

配置切换在 `frontend/.env`：

```bash
# 使用WebRTC
VITE_USE_WEBRTC=true

# 使用WebSocket
VITE_USE_WEBRTC=false
```

## 🔐 安全注意事项

1. **HTTPS要求**
   - WebHID、WebSerial、WebUSB需要HTTPS
   - 本地测试可使用`localhost`

2. **用户授权**
   - 浏览器会要求用户手动授权设备访问
   - 刷新页面需要重新连接

3. **紧急停止**
   - 始终保持急停按钮可用
   - 建议映射多个按钮为急停（如B按钮、空格键）

## 🐛 常见问题

### Q1: 手柄连接了但没反应？
**A:** 
1. 检查浏览器控制台是否有错误
2. 确认在`Screen0`中启用了`enablePeripherals={true}`
3. 尝试重新插拔手柄
4. 检查浏览器兼容性（推荐Chrome/Edge）

### Q2: 摇杆有漂移怎么办？
**A:** 增大死区值：
```typescript
device.setConfig({ deadzone: 0.2 });
```

### Q3: 延迟太高？
**A:** 
1. 切换到WebRTC模式
2. 降低发送频率（添加节流）
3. 使用有线连接代替蓝牙

### Q4: 如何添加自定义外设？
**A:** 继承`BasePeripheralDevice`类：
```typescript
class MyCustomDevice extends BasePeripheralDevice {
  async connect() { /* 实现连接逻辑 */ }
  async disconnect() { /* 实现断开逻辑 */ }
  getState() { /* 返回设备状态 */ }
}
```

## 📚 相关文档

- [外设控制快速开始](./外设控制快速开始.md) - 5分钟上手指南
- [外设控制系统架构说明](./外设控制系统架构说明.md) - 技术架构文档
- [外设控制故障排查](./外设控制故障排查.md) - 问题排查指南
- [3D机器人可视化说明](./3D机器人可视化说明.md) - 3D可视化功能

## 📞 技术支持

遇到问题？
1. 查看浏览器控制台日志
2. 开启调试面板查看实时状态
3. 参考 [外设控制故障排查](./外设控制故障排查.md)

---

**最后更新：** 2024年12月
**版本：** 1.0.0

