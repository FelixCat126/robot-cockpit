# 多屏模式修复说明

## 修复时间
2025-12-11

## 修复的问题

### 1. 摇杆晃动导致机器人3D位移而非腿部活动

**问题描述**：
- 在多屏模式下，摇杆控制时机器人整体在场景中移动（位移）
- 与单屏模式不一致，单屏模式下摇杆控制机器人腿部活动（步行动画）

**根本原因**：
- `PeripheralController` 在检测到摇杆移动时，会发送 `Running` 或 `Walking` 命令
- `Robot3DViewer` 在处理 `Running` 命令时，执行了位移操作：
  ```typescript
  case 'Running':
    robotGroupRef.current.position.add(direction); // 导致位移
  ```

**修复方案**：
修改 `/frontend/src/components/shared/Robot3DViewer.tsx`，将 `Running` 和 `Walking` 命令改为只触发动画，不改变位置：

```typescript
case 'Running':
case 'Walking':
  // 摇杆触发的步行/跑步动画 - 不改变位置，只显示腿部动画
  // 实际的腿部动画由动画循环中的 moveVelocityRef 控制
  break;
```

同时保留 `forward` 和 `backward` 命令的位移逻辑（供按钮触发使用）。

**验证方法**：
1. 启动多屏模式
2. 在主控屏使用摇杆控制
3. 观察 Screen3（3D可视化屏）的机器人
4. 确认机器人腿部有步行动画，但整体位置不改变

---

### 2. 主控屏进入视频界面时三个画布不显示视频

**问题描述**：
- 主控屏（Screen0）点击按钮切换到视频界面（Screen1）时
- 三个视频画布（左臂、主视角、右臂）不显示视频内容

**根本原因**：
- 视频容器的高度没有正确传递到子组件
- CSS flex布局中缺少 `min-height: 0` 和 `height: 100%`

**修复方案**：
修改 `/frontend/src/screens/Screen.css`，为视频相关的容器添加正确的高度设置：

1. `.screen-content` 添加 flex 布局支持：
   ```css
   .screen-content {
     flex: 1;
     padding: 30px;
     overflow-y: auto;
     min-height: 0;
     display: flex;
     flex-direction: column;
   }
   ```

2. 为所有视频容器添加高度设置：
   ```css
   .view-left-arm-multi,
   .view-main-multi,
   .view-right-arm-multi {
     min-height: 0;
     height: 100%;
     /* ... 其他样式 ... */
   }
   ```

**验证方法**：
1. 启动多屏模式
2. 在主控屏（Screen0）点击"视频视角"按钮
3. 确认三个视频画布都正确显示视频内容（摄像头或模拟视频）

---

### 3. 返回机器人选择界面时其他屏幕不退回到等待界面

**问题描述**：
- 在主控屏点击"更换机器人"返回机器人选择界面
- 其他屏幕（Screen1/2/3）没有退回到"等待选择机器人"界面

**根本原因**：
- `handleRobotDeselected` 事件处理逻辑不完整
- localStorage 的同步机制可能不够及时

**修复方案**：
修改 `/frontend/src/layouts/MultiScreenLayout.tsx`，优化 `handleRobotDeselected` 函数：

```typescript
const handleRobotDeselected = () => {
  console.log('[MultiScreenLayout] Robot deselected event received, clearing state for screen:', screenId);
  
  // 立即更新状态
  setSelectedRobotId(null);
  
  // 清除 localStorage
  localStorage.removeItem('robot_cockpit_selected_robot');
  localStorage.removeItem('robot_cockpit_robot_updated');
  
  // 设置一个标记，告诉其他窗口也清除状态
  localStorage.setItem('robot_cockpit_robot_updated', Date.now().toString());
  
  // 触发自定义事件，通知同窗口内的其他组件
  window.dispatchEvent(new CustomEvent('robot_cockpit_robot_update'));
  
  console.log('[MultiScreenLayout] State cleared, should show waiting screen');
};
```

同时添加调试日志到 `renderScreen` 函数，便于排查问题。

**验证方法**：
1. 启动多屏模式（至少3个屏幕）
2. 在主控屏选择一个机器人
3. 确认所有屏幕都显示对应内容
4. 在主控屏点击"更换机器人"
5. 确认：
   - 主控屏显示机器人列表
   - 其他屏幕显示"等待选择机器人"界面
6. 检查浏览器控制台，查看调试日志

---

## 技术细节

### 摇杆控制流程
```
摇杆输入 
  → PeripheralController 检测轴变化
  → 更新 Zustand store (setMoveVelocity)
  → 发送命令到 WebSocket (robot_3d_move)
  → 发送动画状态命令 (Running/Walking/Idle)
  → Robot3DViewer 监听 store 变化
  → 动画循环根据 moveVelocity 更新腿部动画
```

### 视频显示流程
```
Screen0 切换到 Screen1
  → Screen1 渲染三个 VideoPlayer 组件
  → 每个 VideoPlayer 初始化视频流（摄像头或模拟）
  → CSS flex 布局确保容器有正确高度
  → video 元素填充容器并显示视频
```

### 状态同步流程
```
主控屏点击"更换机器人"
  → handleDeselectRobot 被调用
  → communicationFactory.disconnectRobot()
  → websocketService.deselectRobot() 发送事件到后端
  → 后端广播 robot_deselected 到所有客户端
  → 所有屏幕的 MultiScreenLayout 监听到事件
  → handleRobotDeselected 被调用
  → setSelectedRobotId(null) 触发重新渲染
  → 显示"等待选择机器人"界面
```

---

## 测试建议

### 完整测试流程
1. **启动系统**
   ```bash
   # 后端
   cd backend && node server.js
   
   # 前端（多屏模式）
   cd frontend && npm run dev
   ```

2. **打开多个浏览器窗口**
   - Screen0 (主控): `http://localhost:5173/?screen=0`
   - Screen1 (视频): `http://localhost:5173/?screen=1`
   - Screen2 (状态): `http://localhost:5173/?screen=2`
   - Screen3 (3D): `http://localhost:5173/?screen=3`

3. **测试摇杆控制**
   - 连接游戏手柄/街机摇杆
   - 在 Screen0 操作摇杆
   - 在 Screen3 观察机器人动画
   - 确认只有腿部活动，无位移

4. **测试视频显示**
   - 在 Screen0 点击"视频视角"按钮
   - 确认三个视频画布都显示内容
   - 测试视频控制按钮（开启/关闭）

5. **测试状态同步**
   - 选择机器人后，所有屏幕显示对应内容
   - 点击"更换机器人"
   - 确认所有屏幕正确退回等待界面

---

## 后续优化建议

1. **性能优化**
   - 考虑使用 SharedArrayBuffer 优化多屏视频同步
   - 优化 VideoPlayer 的初始化逻辑，减少重复的摄像头请求

2. **用户体验**
   - 添加视频加载进度提示
   - 优化状态同步的视觉反馈

3. **代码质量**
   - 移除调试日志前确保功能稳定
   - 考虑添加单元测试覆盖关键状态同步逻辑

---

## 修改的文件清单

1. `/frontend/src/components/shared/Robot3DViewer.tsx`
   - 修改 `Running`/`Walking` 命令处理逻辑

2. `/frontend/src/screens/Screen.css`
   - 修改 `.screen-content` 样式
   - 修改 `.view-left-arm-multi` 样式
   - 修改 `.view-main-multi` 样式
   - 修改 `.view-right-arm-multi` 样式

3. `/frontend/src/layouts/MultiScreenLayout.tsx`
   - 优化 `handleRobotDeselected` 函数
   - 添加调试日志到 `renderScreen` 函数

---

## 已知限制

1. 调试日志会在生产环境打印，需要在发布前移除
2. localStorage 同步可能在某些浏览器有轻微延迟
3. 视频初始化时可能短暂显示黑屏，属于正常现象
