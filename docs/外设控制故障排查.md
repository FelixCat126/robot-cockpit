# 外设控制故障排查指南 (Peripheral Troubleshooting Guide)
**📝 文档说明：** 外设控制常见问题和解决方案，帮助快速诊断和修复问题

## 🔍 常见问题和解决方案

### 1. 外设无法连接

#### 问题表现
- 外设调试面板显示"未连接"或"搜索设备中..."
- 按下按钮没有反应
- 控制台显示"Gamepad连接超时"

#### 可能原因和解决方案

**原因 1：蓝牙未配对**
```bash
# 解决方案：使用系统蓝牙设置配对设备
1. 打开系统蓝牙设置
2. 将外设设置为配对模式
3. 在系统中搜索并配对
4. 刷新浏览器页面
```

**原因 2：设备处于休眠状态**
```bash
# 解决方案：唤醒设备
1. 按下手柄上的任意按钮
2. 等待 2-3 秒
3. 查看外设调试面板状态变化
4. 如果仍未连接，刷新页面
```

**原因 3：浏览器未获取权限**
```bash
# 解决方案：确认浏览器权限
1. 查看地址栏是否有权限提示
2. 允许 Gamepad API 访问
3. 刷新页面重试
```

**原因 4：驱动程序问题**
```bash
# Linux系统
sudo apt-get install joystick
sudo apt-get install jstest-gtk

# 测试设备
jstest /dev/input/js0

# Windows系统
# 设置 > 游戏控制器 > 查看设备状态
```

### 2. 外设断连后无法重连

#### 问题表现
- 设备之前可以使用
- 长时间不操作后设备断连
- 刷新页面才能重新连接

#### 解决方案

系统已内置自动重连机制，但如果仍然断连：

**方法 1：手动触发重连**
1. 按下手柄上的任意按钮
2. 系统会自动尝试重连（最多 10 次）
3. 观察调试面板的重连提示

**方法 2：重置连接**
1. 关闭浏览器标签页
2. 重新打开应用
3. 等待设备自动连接

**方法 3：系统层面重置**
```bash
# 断开并重新连接蓝牙
1. 系统蓝牙设置中断开设备
2. 等待 5 秒
3. 重新连接设备
4. 刷新浏览器
```

### 3. 按钮触发两次动作

#### 问题表现
- 按一次左转按钮，机器人旋转 90° 而不是 45°
- 按一次动作按钮，执行了两次动作

#### 解决方案

这个问题已在最新版本中修复。如果仍然出现：

**检查代码版本**
```bash
# 确认是否使用最新代码
git pull origin main
npm run build
npm start
```

**临时解决方案**
- 增加按钮防抖时间（当前默认 300ms）
- 放慢按钮按压速度
- 确保按钮完全松开后再按下

### 4. 摇杆控制不连贯

#### 问题表现
- 摇杆推动后机器人动作延迟
- 动作卡顿或跳跃
- 松开摇杆后机器人继续移动

#### 解决方案

**方法 1：调整死区设置**
当前死区设置为 0.15（15%），可以在代码中调整：

```typescript
// frontend/src/components/shared/PeripheralController.tsx
const deadzone = 0.15;  // 调整为 0.1 或 0.2
```

**方法 2：检查系统性能**
```bash
# 查看 CPU 使用率
top

# 查看浏览器进程
ps aux | grep chromium
```

**方法 3：降低命令发送频率**
```typescript
// frontend/src/components/shared/PeripheralController.tsx
const sendIntervalMs = 100;  // 从 100ms 调整为 200ms
```

### 5. Web 按钮无法控制机器人

#### 问题表现
- 点击 Web 按钮没有反应
- 控制台显示"WebSocket未连接"
- 机器人模型不执行动作

#### 解决方案

**检查 1：WebSocket 连接状态**
```javascript
// 打开浏览器控制台，检查连接状态
// 应该显示：🟢 ROS2已连接
```

如果显示未连接：
1. 检查后端服务是否运行：`curl http://localhost:3000/api/health`
2. 检查网络连接
3. 刷新页面重新连接

**检查 2：登录状态**
- 确认已登录系统
- 确认已选择机器人
- 刷新页面后重新登录

**检查 3：控制台错误**
```javascript
// 查看控制台是否有错误
// 常见错误：
// - "WebSocket connection failed"
// - "setCommand is not a function"
```

### 6. 多屏模式下 Screen 3 不显示内容

#### 问题表现
- Screen 3 显示空白或加载中
- 其他屏幕正常显示
- Screen 3 没有收到 3D 命令

#### 解决方案

**检查 1：屏幕 ID 配置**
```javascript
// 确认 URL 正确
http://localhost:3000?screen=3
```

**检查 2：WebSocket 订阅**
```javascript
// Screen 3 应该订阅 robot_3d_command 话题
// 检查控制台日志
```

**检查 3：后端配置**
```javascript
// backend/config/index.js
screen: {
  count: 4,  // 确认至少为 4
}
```

**检查 4：登录和机器人选择**
- Screen 3 也需要登录
- Screen 3 也需要选择机器人
- 确认多屏同步状态

### 7. 按钮映射不正确

#### 问题表现
- 按下按钮 A 执行了错误的动作
- LB/RB 按钮不工作
- 按钮序号不匹配

#### 解决方案

**方法 1：查看调试面板**
1. 点击"显示外设调试"按钮
2. 按下问题按钮
3. 查看按钮索引（buttonIndex）
4. 对照映射表确认

**方法 2：使用浏览器工具测试**
```javascript
// 打开控制台，运行：
window.addEventListener('gamepadconnected', (e) => {
  console.log('Gamepad connected:', e.gamepad);
  setInterval(() => {
    const gp = navigator.getGamepads()[e.gamepad.index];
    console.log('Buttons:', gp.buttons.map((b, i) => 
      b.pressed ? `Button ${i}` : null).filter(Boolean)
    );
  }, 1000);
});
```

**方法 3：自定义映射**
编辑 `frontend/src/utils/peripherals/InputMapper.ts`：

```typescript
// 修改按钮索引以匹配你的设备
mapper.addRule({
  id: 'button-a-wave',
  trigger: {
    type: InputEventType.BUTTON_DOWN,
    buttonIndex: 0,  // 修改这里
  },
  // ...
});
```

### 8. 性能问题（卡顿、延迟）

#### 问题表现
- 控制反应缓慢
- 浏览器卡顿
- 控制台日志刷屏

#### 解决方案

**方法 1：减少日志输出**
当前版本已精简日志，如果仍然过多：

```bash
# 临时禁用调试日志
1. 不要开启"显示外设调试"
2. 关闭浏览器控制台
```

**方法 2：降低命令频率**
```typescript
// frontend/src/components/shared/PeripheralController.tsx
const sendIntervalMs = 200;  // 从 100ms 增加到 200ms
```

**方法 3：优化浏览器性能**
```bash
# Chromium 性能优化参数
chromium-browser \
  --disable-gpu \
  --disable-software-rasterizer \
  --disable-dev-shm-usage \
  --no-sandbox \
  YOUR_URL
```

### 9. 键盘控制无效

#### 问题表现
- 按键盘 WASD 没有反应
- 键盘事件被其他元素捕获

#### 解决方案

**方法 1：确认焦点**
- 点击页面任意位置确保页面获得焦点
- 不要在输入框中按键

**方法 2：检查键盘设备状态**
```javascript
// 控制台查看键盘设备是否启动
// 应该显示：KeyboardDevice - connected
```

**方法 3：手动启动键盘设备**
```javascript
// 如果键盘设备未启动，刷新页面
```

### 10. 外设在笔记本待机后失效

#### 问题表现
- 笔记本待机或休眠后
- 外设连接显示断开
- 手动操作也无法唤醒

#### 解决方案

**推荐方案：刷新页面**
1. 唤醒笔记本
2. 刷新浏览器标签页（F5）
3. 等待设备自动重连

**系统层面解决**
```bash
# Linux 配置蓝牙唤醒
sudo nano /etc/bluetooth/main.conf
# 添加或修改：
# FastConnectable = true
# ReconnectAttempts = 7

sudo systemctl restart bluetooth
```

## 📊 诊断工具

### 1. 外设调试面板
- 显示设备连接状态
- 实时显示轴值和按钮状态
- 显示事件日志

使用方法：
1. 点击控制面板上的"🎮 显示外设调试"按钮
2. 查看设备列表和状态
3. 操作外设查看实时数据

### 2. 浏览器控制台
打开控制台（F12）查看详细日志：

```javascript
// 关键日志关键词：
[PeripheralController] // 外设控制器日志
[GamepadDevice]        // 游戏手柄设备日志
[PeripheralManager]    // 设备管理器日志
[Robot3DViewer]        // 3D 渲染日志
[ControlPanel]         // 控制面板日志
```

### 3. 系统工具

**Linux 游戏手柄测试**
```bash
# 安装测试工具
sudo apt-get install jstest-gtk

# 运行图形化测试工具
jstest-gtk

# 命令行测试
jstest /dev/input/js0
```

**查看设备列表**
```bash
# Linux
ls -la /dev/input/js*
ls -la /dev/input/event*

# 查看设备信息
cat /proc/bus/input/devices
```

## 🆘 获取帮助

如果以上方法都无法解决问题，请：

1. **收集信息**
   - 浏览器类型和版本
   - 操作系统版本
   - 外设型号
   - 控制台错误日志
   - 复现步骤

2. **查看相关文档**
   - [外设控制系统使用指南](./外设控制系统使用指南.md)
   - [外设控制快速开始](./外设控制快速开始.md)
   - [3D机器人可视化说明](./3D机器人可视化说明.md)

3. **提交 Issue**
   - 提供完整的问题描述
   - 附上错误日志
   - 说明已尝试的解决方案

## 📝 已知问题

### 1. Firefox 兼容性
- Firefox 对 Gamepad API 的支持有差异
- 建议使用 Chrome/Chromium

### 2. macOS Bluetooth LE
- 某些 BLE 设备在 macOS 上可能需要额外配置
- 建议使用 USB 连接或标准蓝牙设备

### 3. 高刷新率显示器
- 在高刷新率显示器上可能出现性能问题
- 建议限制浏览器刷新率或降低显示器刷新率

