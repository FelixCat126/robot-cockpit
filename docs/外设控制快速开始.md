# 外设控制快速开始 (Peripheral Quick Start)
**📝 文档说明：** 5分钟快速上手指南，帮助你快速测试和使用外设控制功能

## ⚡ 5分钟快速上手

### 步骤1：启动服务（已完成）
外设控制系统已经集成到项目中，无需额外安装。

### 步骤2：连接外设

#### 选项A：使用游戏手柄（推荐）
1. 将Xbox/PlayStation手柄通过USB连接到电脑
2. 或通过蓝牙配对手柄
3. 确认手柄指示灯亮起

#### 选项B：使用键盘（备用）
无需额外操作，键盘控制默认可用。

### 步骤3：打开控制台
```bash
# 启动项目
npm start
```

访问 `http://localhost:3000`，登录后查看Screen0（控制屏）。

### 步骤4：查看外设状态

在Screen0中，你会看到：
- 🟢 外设控制已启用（如果手柄已连接）
- 🎮 点击"显示外设调试"按钮查看实时状态

### 步骤5：开始控制

#### 使用游戏手柄：
- **左摇杆**：推动控制机器人移动和转向
- **A/B/C/D按钮**：触发特定动作
- **LB/RB按钮**：左转/右转

#### 使用键盘：
- **W/S/A/D**：前后左右移动
- **空格**：急停

## 🎯 当前控制映射

### 游戏手柄完整映射

| 输入 | 功能 | 效果 |
|------|------|------|
| **左摇杆前推** | 前进 | 机器人前进，速度越快动画越快（Walking→Running） |
| **左摇杆后拉** | 后退 | 机器人后退 |
| **左摇杆左推** | 左转 | 边前进边左转 |
| **左摇杆右推** | 右转 | 边前进边右转 |
| **左摇杆复位** | 停止 | 机器人停止，恢复 Idle 动画 |
| **A按钮** | 挥手 | Wave 动画，可重复触发 |
| **B按钮** | 点赞 | ThumbsUp 动画，可重复触发 |
| **C按钮** | 跨栏 | WalkJump 动画，可重复触发 |
| **D按钮** | 跳跃 | Jump 动画，可重复触发 |
| **LB按钮** | 左转45° | 机器人原地左转45°，可连续按 |
| **RB按钮** | 右转45° | 机器人原地右转45°，可连续按 |

### 键盘映射表

| 按键 | ROS话题 | 说明 |
|------|---------|------|
| W | `/cmd_vel` | 前进（0.5 m/s） |
| S | `/cmd_vel` | 后退（-0.5 m/s） |
| A | `/cmd_vel` | 左转（0.5 rad/s） |
| D | `/cmd_vel` | 右转（-0.5 rad/s） |
| Space | `/emergency_stop` | 急停 |

## 🔧 自定义配置

### 调整死区（防止摇杆漂移）

编辑 `frontend/src/components/shared/PeripheralController.tsx`：

```typescript
// 找到 deadzone 设置
const deadzone = 0.15;  // 调整为 0.1（更灵敏）或 0.2（降低灵敏度）
```

### 启用/禁用外设控制

编辑 `frontend/src/screens/Screen0.tsx`：

```typescript
<ControlPanel 
  screenId={screenId}
  enablePeripherals={true}       // 改为false禁用
  showPeripheralDebug={true}     // 改为true默认显示调试
/>
```

### 修改速度参数

编辑 `frontend/src/components/shared/PeripheralController.tsx`：

```typescript
// 找到速度计算部分
const linearX = Math.abs(leftStickY) > deadzone ? -leftStickY * 0.5 : 0;  // 调整 0.5
const angularZ = Math.abs(leftStickX) > deadzone ? leftStickX * 1.0 : 0;  // 调整 1.0
```

## 🐛 快速故障排除

### 问题1：手柄连接了但没反应

**解决方法：**
1. 打开浏览器控制台（F12）
2. 查看是否有设备连接日志
3. 点击"显示外设调试"查看设备状态
4. 尝试按动手柄按钮，观察是否有事件触发

**可能原因：**
- 浏览器不支持Gamepad API（使用Chrome/Edge）
- 手柄驱动未安装
- 手柄已被其他程序占用

### 问题2：摇杆有轻微漂移

**解决方法：**
增大死区值（见上方"调整死区"）

### 问题3：延迟太高

**解决方法：**
1. 使用有线连接代替蓝牙
2. 检查系统性能（CPU占用率）
3. 关闭不必要的后台程序

### 问题4：按钮触发两次

**解决方法：**
系统已内置 300ms 防抖机制。如果仍然出现：
1. 检查手柄是否有硬件问题
2. 尝试更换手柄
3. 增加防抖时间

### 问题5：外设断连后无法重连

**解决方法：**
系统已内置自动重连机制（最多10次）：
1. 按下手柄上的任意按钮唤醒设备
2. 等待自动重连（观察调试面板提示）
3. 如果仍然失败，刷新浏览器页面

## 📊 监控和调试

### 查看实时状态

点击"🎮 显示外设调试"按钮，你会看到：

1. **设备连接状态**
   - 🟢 绿色：已连接
   - 🟡 黄色：连接中
   - 🔴 红色：断开连接

2. **轴向实时值**
   - 摇杆/踏板的当前值
   - 范围：-1.0（左/上）到 +1.0（右/下）

3. **按钮状态**
   - 显示当前按下的按钮

4. **事件日志**
   - 最近10条输入事件
   - 包含时间戳和详细信息

### 浏览器控制台日志

```javascript
// 成功连接示例
[PeripheralController] 外设控制系统已启动
[Gamepad Device] 已连接: Xbox Controller
[PeripheralManager] 所有设备已启动

// 命令发送示例
[PeripheralController] 按钮0按下
```

## 🎮 推荐外设

### 游戏手柄
- ⭐⭐⭐⭐⭐ Xbox Series X/S 手柄
- ⭐⭐⭐⭐⭐ Xbox One 手柄
- ⭐⭐⭐⭐ PlayStation 4/5 手柄
- ⭐⭐⭐⭐ Logitech F710 无线手柄

### 飞行摇杆
- ⭐⭐⭐⭐⭐ Logitech Extreme 3D Pro
- ⭐⭐⭐⭐ Thrustmaster T.16000M

### 方向盘套装
- ⭐⭐⭐⭐⭐ Logitech G29/G920
- ⭐⭐⭐⭐ Thrustmaster T150

## 📚 下一步

- 📖 查看完整文档：[外设控制系统使用指南](./外设控制系统使用指南.md)
- 🏗️ 了解架构设计：[外设控制系统架构说明](./外设控制系统架构说明.md)
- 🔧 遇到问题：[外设控制故障排查](./外设控制故障排查.md)
- 🤖 3D可视化：[3D机器人可视化说明](./3D机器人可视化说明.md)

## 💡 提示

1. **始终确保急停可用**
   - 空格键可以触发急停
   - 急停是最高优先级命令

2. **测试前先了解控制**
   - 使用调试面板观察输入
   - 确认命令正确映射

3. **生产环境建议**
   - 使用有线连接
   - 启用WebRTC模式
   - 配置合适的死区值

4. **安全第一**
   - 测试时保持安全距离
   - 确保紧急停止按钮随时可用
   - 逐步测试，从低速开始

---

**需要帮助？** 查看浏览器控制台日志，或参考 [外设控制故障排查](./外设控制故障排查.md)

