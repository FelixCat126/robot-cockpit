# 3D机器人可视化系统说明 (3D Robot Visualization)
**📝 文档说明：** 3D机器人可视化功能的详细说明，包括使用方法、配置选项和功能特性

## 📖 概述

Robot Cockpit 集成了基于 Three.js 的 3D 机器人可视化系统，可以实时显示机器人的状态和动画。

## ✨ 主要功能

### 1. **3D 模型渲染**
- ✅ 使用宇树（Unitree）G1人形机器人URDF模型
- ✅ 完整的STL mesh文件支持（35个部件）
- ✅ 29自由度（DOF）关节系统
- ✅ 实时渲染和动画播放
- ✅ 支持从GitHub直接加载官方模型

### 2. **动作库**
系统支持以下预设动作：
- **基本动作**
  - `Idle` - 待机姿势
  - `Walking` - 行走动画
  - `Running` - 奔跑动画
  
- **肢体动作**
  - `Wave` - 挥手
  - `ThumbsUp` - 点赞
  - `WalkJump` - 跨栏
  - `Jump` - 跳跃
  
- **其他动作**
  - `Dance` - 跳舞
  - `left` - 左转 45°
  - `right` - 右转 45°

### 3. **控制方式**

#### Web 界面按钮
- 点击控制面板上的动作按钮触发对应动作
- 支持重复点击，每次都会重新执行动作

#### 外设控制（游戏手柄）
- **摇杆**：前后推拉控制前进/后退，自动切换行走/奔跑动画
- **按钮 A**：挥手
- **按钮 B**：点赞
- **按钮 C**：跨栏
- **按钮 D**：跳跃
- **LB 按钮**：左转 45°
- **RB 按钮**：右转 45°

#### 键盘控制
- **W**：前进
- **S**：后退
- **A**：左转
- **D**：右转
- **空格**：急停

### 4. **显示模式**

#### 单屏模式
- 3D 机器人显示为视频流上的小窗口（320x180px）
- 位于视频画面左上角
- 自动旋转背景，机器人始终面向前方

#### 多屏模式
- **Screen 0**：主控屏，包含控制面板和小窗口 3D 视图
- **Screen 3**：专用 3D 屏，大尺寸显示（640x1000px）
- 跨屏同步：所有操作在多个屏幕间实时同步

### 5. **环境效果**

#### 赛博朋克风格背景
- ✅ 双色灯光系统（青色 + 品红色）
- ✅ 动态粒子效果
- ✅ 发光地板网格
- ✅ 四角光柱装饰
- ✅ 背景旋转（机器人保持面向前方）

## 🎮 使用方法

### 启动 3D 可视化

1. **单屏模式**
   ```bash
   npm start
   ```
   3D 机器人会自动显示在视频流左上角

2. **多屏模式**
   ```bash
   DISPLAY_MODE=multi npm start
   ```
   - 在 Screen 0 查看控制面板和小窗口
   - 在 Screen 3 查看大尺寸 3D 视图

### 控制机器人

#### 使用 Web 按钮
1. 登录系统并选择机器人
2. 在控制面板找到"动作控制"区域
3. 点击对应的动作按钮

#### 使用游戏手柄
1. 连接蓝牙游戏手柄到电脑
2. 刷新页面或点击"显示外设调试"按钮
3. 等待设备连接成功（绿色指示）
4. 按下手柄按钮或操作摇杆

### 配置选项

`Robot3DViewer` 组件支持以下配置：

```typescript
<Robot3DViewer 
  width={320}              // 宽度（像素）
  height={180}             // 高度（像素）
  enableAutoRotate={true}  // 是否自动旋转背景
  showGrid={false}         // 是否显示网格
  showAxes={false}         // 是否显示坐标轴
  backgroundColor="#1a1a2e" // 背景颜色
/>
```

## 🔧 技术实现

### 架构组件

1. **Robot3DViewer.tsx**
   - 核心 3D 渲染组件
   - 使用 Three.js 渲染引擎
   - 监听 Zustand store 的命令状态

2. **URDFLoader.ts** ⭐ 新增
   - URDF 模型加载器（支持宇树G1机器人）
   - 解析URDF XML文件
   - 加载STL mesh文件（使用Three.js STLLoader）
   - 构建完整的关节层级结构
   - 支持异步并行加载多个mesh文件

3. **GLTFRobotLoader.ts**
   - GLTF 模型加载器（备用）
   - 动画管理和播放控制
   - 支持 DRACO 压缩

4. **robot3DStore.ts**
   - Zustand 状态管理
   - 存储当前命令和机器人状态
   - 支持跨组件通信

### 宇树G1机器人模型 ⭐ 新增

**模型信息：**
- **名称**：Unitree G1 29DOF Rev 1.0
- **来源**：[unitree_ros GitHub仓库](https://github.com/unitreerobotics/unitree_ros/tree/master/robots/g1_description)
- **文件位置**：`frontend/public/models/g1_robot/`
- **URDF文件**：`g1_29dof_rev_1_0.urdf`
- **Mesh文件**：35个STL文件（约20MB）

**关节系统：**
- 腿部：每条腿6个关节（髋关节3个、膝关节1个、踝关节2个）
- 躯干：腰部2个关节
- 手臂：每条手臂7个关节（肩部3个、肘部1个、腕部3个）
- 头部：1个关节
- 总计：29个自由度

### 命令流程

```
用户操作（Web/外设/键盘）
    ↓
setCommand(commandId + '_' + timestamp)
    ↓
Robot3DViewer useEffect 监听
    ↓
提取纯命令 ID（去掉时间戳）
    ↓
switch(commandId) 执行对应动作
    ↓
AnimationMixer 播放动画
```

### 时间戳机制

为了支持连续触发相同命令，系统在每个命令后添加时间戳：

```typescript
// 命令格式：'commandId_timestamp'
'Wave_1765181795753'
'left_1765181801638'
```

这确保即使连续执行相同动作，React 的 `useEffect` 也能检测到状态变化并触发。

## 📊 性能优化

### 1. **动画优化**
- 使用 `LoopOnce` 避免动画卡帧
- 动作结束后自动返回 `Idle` 状态
- 智能动画切换（Idle ↔ Walking ↔ Running）

### 2. **命令节流**
- 摇杆命令：10Hz 发送频率
- 按钮防抖：300ms 防抖时间
- 日志节流：1Hz 打印频率

### 3. **渲染优化**
- 使用 `requestAnimationFrame` 动画循环
- 自动管理渲染器生命周期
- 组件卸载时清理资源

## 🚀 未来计划

### URDF 模型支持
- [x] 加载自定义 URDF 机器人模型（✅ 已完成 - 2024-12-09）
- [x] 支持STL mesh文件加载（✅ 已完成 - 2024-12-09）
- [x] 解析URDF关节层级结构（✅ 已完成 - 2024-12-09）
- [ ] 实时同步 ROS `/joint_states` 话题
- [ ] 关节状态可视化
- [ ] 多机器人模型切换

### WebRTC 集成（计划中）
- [ ] 远程 ROS 通过 WebRTC 通信
- [ ] 低延迟实时控制
- [ ] 视频流集成

## 🔍 故障排查

### 3D 模型不显示
1. 检查控制台是否有加载错误
2. 确认网络连接正常（模型从 CDN 加载）
3. 检查浏览器是否支持 WebGL

### 动作不响应
1. 确认已登录并选择机器人
2. 检查 WebSocket 连接状态（应显示"已连接"）
3. 查看控制台是否有命令日志

### 外设控制无效
1. 确认外设已连接（蓝色/绿色状态）
2. 检查浏览器权限（需要 Gamepad API 权限）
3. 查看外设调试面板确认输入信号

### 多屏同步问题
1. 确认所有屏幕都已连接 WebSocket
2. 检查后端是否正确转发 `robot_3d_command` 话题
3. 查看 Screen 3 的控制台日志

## 📖 相关文档

- [外设控制系统使用指南](./外设控制系统使用指南.md)
- [外设控制快速开始](./外设控制快速开始.md)
- [外设控制系统架构说明](./外设控制系统架构说明.md)
- [显示模式说明](./显示模式说明.md)

