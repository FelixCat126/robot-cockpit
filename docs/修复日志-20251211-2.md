# 修复日志 - 2025-12-11 (第二次)

## 问题反馈

用户报告以下问题仍然存在：

1. **摇杆控制不了机器人活动**
   - 错误日志：`Cannot publish to robot_3d_command: not connected`
   - 这是因为 ROS2Bridge 未连接

2. **主控屏返回机器人列表时其他屏不退回**
   - 其他屏幕应该显示"等待选择机器人"界面

3. **主控屏点击视频按钮后仍然看不到视频**
   - 控制台显示请求摄像头但没有视频显示

4. **WebSocket 重复连接警告**
   - `[WebSocket] Already connected`

---

## 本次修复

### 1. 修复状态同步逻辑错误

**问题**：`handleRobotDeselected` 中的 localStorage 操作不正确

**修改文件**：`/frontend/src/layouts/MultiScreenLayout.tsx`

**修改内容**：
```typescript
// 之前：先删除 robot_updated 再设置，可能导致混乱
localStorage.removeItem('robot_cockpit_robot_updated');
localStorage.setItem('robot_cockpit_robot_updated', Date.now().toString());

// 现在：只删除 robot_cockpit_selected_robot，然后更新时间戳
localStorage.removeItem('robot_cockpit_selected_robot');
localStorage.setItem('robot_cockpit_robot_updated', Date.now().toString());
```

### 2. 修复视频容器高度问题

**问题**：`.video-content-multi` 使用 `height: 100%` 导致在 flex 容器中高度计算错误

**修改文件**：`/frontend/src/screens/Screen.css`

**修改内容**：
```css
/* 之前 */
.video-content-multi {
  /* ... */
  height: 100%;
}

/* 现在 */
.video-content-multi {
  flex: 1;  /* 使用 flex 而不是固定高度 */
  /* ... */
  /* 移除 height: 100% */
}
```

### 3. 添加详细的调试日志

**修改文件**：
1. `/frontend/src/components/shared/VideoPlayer.tsx`
   - 添加状态打印日志

2. `/frontend/src/components/shared/PeripheralController.tsx`
   - 添加移动速度更新日志

3. `/frontend/src/components/shared/Robot3DViewer.tsx`
   - 添加速度接收和计算日志

**调试日志示例**：
```javascript
// VideoPlayer
console.log(`[VideoPlayer] screenId=${_screenId}, compact=${compact}, isVideoLoading=${isVideoLoading}, ...`);

// PeripheralController
console.log('[PeripheralController] 更新移动速度:', velocityData);

// Robot3DViewer
console.log('[Robot3DViewer] 收到移动速度更新:', newVelocity);
console.log('[Robot3DViewer] 速度大小:', speed, '是否有移动:', hasMovement);
```

### 4. 创建调试指南文档

**文档位置**：`/docs/调试指南.md`

包含：
- 三个问题的详细排查步骤
- 可能的原因分析
- 临时解决方案
- 通用调试技巧
- 预期的日志输出

---

## 排查建议

### 立即检查的事项

1. **打开浏览器控制台**
   - 主控屏（Screen0）
   - 至少一个其他屏（Screen1/2/3）
   - 查看是否有新的调试日志

2. **测试摇杆控制**
   - 操作摇杆
   - 查看控制台是否出现：
     ```
     [PeripheralController] 更新移动速度: ...
     [Robot3DViewer] 收到移动速度更新: ...
     ```
   - 如果没有日志，说明 PeripheralController 没有启用或摇杆没有连接

3. **测试状态同步**
   - 选择机器人
   - 点击"更换机器人"
   - 查看所有屏幕的控制台是否出现：
     ```
     [MultiScreenLayout] Robot deselected event received, clearing state for screen: X
     [MultiScreenLayout] State cleared, should show waiting screen
     ```
   - 检查界面是否正确更新

4. **测试视频显示**
   - 点击"视频视角"按钮
   - 查看控制台是否出现：
     ```
     [VideoPlayer] screenId=X, compact=true, isVideoLoading=..., videoError=..., ...
     ```
   - 使用浏览器开发者工具检查视频容器的高度：
     ```javascript
     document.querySelector('.view-section-multi').offsetHeight
     document.querySelector('.video-container').offsetHeight
     ```

---

## 可能仍需修复的问题

### 1. ROS2Bridge 未连接

**现象**：后端日志显示 `Cannot publish to robot_3d_command: not connected`

**原因**：ROS2Bridge 没有启动或配置错误

**影响**：
- 不影响前端 3D 动画（使用本地状态）
- 影响与真实机器人的通信

**解决方案**：
1. 检查后端配置 `backend/config/index.js`
2. 确认 ROS2 环境是否正确设置
3. 如果只需要前端演示，可以忽略此警告

### 2. WebSocket 重复连接

**现象**：`[WebSocket] Already connected`

**原因**：多个组件重复调用 `websocketService.connect()`

**影响**：轻微，只是警告

**解决方案**：
- 确保 `websocketService.connect()` 只在顶层组件调用一次
- 或者在 `connect()` 方法中添加更好的检查逻辑

### 3. 摄像头权限

**现象**：VideoPlayer 请求摄像头但没有显示

**可能原因**：
- 浏览器拒绝了摄像头权限
- 没有可用的摄像头设备
- 模拟视频初始化失败

**解决方案**：
1. 检查浏览器地址栏左侧是否有摄像头图标
2. 点击图标，允许摄像头权限
3. 如果没有摄像头，应该自动切换到模拟视频
4. 查看控制台是否有错误信息

---

## 下一步

1. **收集完整日志**
   - 打开所有屏幕
   - 复现问题
   - 复制控制台的完整日志输出

2. **提供截图**
   - 视频界面的截图（显示黑屏/空白）
   - 浏览器开发者工具截图（显示元素高度）

3. **提供环境信息**
   - 浏览器版本
   - 操作系统
   - 是否有摄像头设备
   - 是否有游戏手柄/摇杆连接

4. **如果调试日志足够详细**
   - 可以精确定位问题所在
   - 进行针对性修复

---

## 修改文件清单

1. `/frontend/src/layouts/MultiScreenLayout.tsx` - 修复状态同步逻辑
2. `/frontend/src/screens/Screen.css` - 修复视频容器高度
3. `/frontend/src/components/shared/VideoPlayer.tsx` - 添加调试日志
4. `/frontend/src/components/shared/PeripheralController.tsx` - 添加调试日志
5. `/frontend/src/components/shared/Robot3DViewer.tsx` - 添加调试日志
6. `/docs/调试指南.md` - 新增调试文档
7. `/docs/修复日志-20251211-2.md` - 本文档
