# Backend 功能说明

## 📋 概述

Backend部分实现了完整的机器人驾驶舱后端服务，包括ROS2数据通信、WebSocket服务、屏幕管理和HTTP API。

## 🏗️ 架构模块

### 1. ROS2 Bridge 模块 (`backend/modules/ros2-bridge/ROS2Bridge.js`)

**功能：** 与ROS2 Bridge (rosbridge_suite) 进行WebSocket通信

#### ✅ 已实现功能

1. **连接管理**
   - WebSocket连接建立
   - 自动重连机制（可配置重连间隔和最大尝试次数）
   - 连接状态监控
   - 错误处理和日志记录

2. **话题订阅 (Subscribe)**
   - 订阅ROS2话题
   - 支持指定消息类型
   - 订阅ID管理
   - 自动重新订阅（连接恢复后）

3. **话题发布 (Publish)**
   - 发布消息到ROS2话题
   - 支持指定消息类型
   - 消息格式转换（JSON）

4. **服务调用 (Service Call)**
   - 调用ROS2服务
   - 支持服务参数传递
   - 服务响应处理

5. **消息处理**
   - 解析rosbridge_suite消息格式
   - 话题数据转发
   - 服务响应处理
   - 状态消息处理

#### 🔌 连接配置

**支持本机和远端连接：**

```javascript
// 配置文件: backend/config/index.js
ros2Bridge: {
  url: process.env.ROS2_BRIDGE_URL || 'ws://localhost:9090',
  // 本机: ws://localhost:9090
  // 远端: ws://192.168.1.100:9090
  // 或: ws://robot-ip:9090
}
```

**环境变量配置：**
```bash
# 连接本机ROS2 Bridge
ROS2_BRIDGE_URL=ws://localhost:9090

# 连接远端ROS2 Bridge
ROS2_BRIDGE_URL=ws://192.168.1.100:9090

# 或使用域名
ROS2_BRIDGE_URL=ws://robot.local:9090
```

#### 📡 通信协议

使用 **rosbridge_suite** 的WebSocket协议：
- 协议标准：rosbridge_suite WebSocket JSON API
- 消息格式：JSON
- 支持的操作：
  - `subscribe` - 订阅话题
  - `unsubscribe` - 取消订阅
  - `publish` - 发布消息
  - `call_service` - 调用服务
  - `service_response` - 服务响应

#### 🔄 数据流

```
ROS2节点 → rosbridge_suite → ROS2Bridge模块 → WebSocketService → 前端
```

---

### 2. WebSocket 服务模块 (`backend/modules/websocket/WebSocketService.js`)

**功能：** 前端与后端之间的实时双向通信桥梁

#### ✅ 已实现功能

1. **客户端管理**
   - 客户端连接/断开管理
   - 屏幕ID注册
   - 客户端状态跟踪
   - 心跳检测（ping/pong）

2. **ROS2数据转发**
   - 广播话题数据到所有客户端
   - 发送数据到特定屏幕
   - 实时数据推送

3. **客户端请求处理**
   - 话题订阅请求
   - 话题取消订阅请求
   - 话题发布请求
   - 屏幕注册

4. **事件系统**
   - 客户端连接/断开事件
   - 屏幕注册事件
   - 话题订阅/发布事件

#### 📨 支持的事件

**客户端 → 服务器：**
- `register_screen` - 注册屏幕ID
- `subscribe_topic` - 订阅ROS2话题
- `unsubscribe_topic` - 取消订阅
- `publish_topic` - 发布消息到ROS2
- `ping` - 心跳

**服务器 → 客户端：**
- `topic_data` - ROS2话题数据
- `screen_registered` - 屏幕注册响应
- `pong` - 心跳响应

---

### 3. 屏幕管理模块 (`backend/modules/screen-manager/ScreenManager.js`)

**功能：** 管理多个显示器和浏览器实例

#### ✅ 已实现功能

1. **显示器检测**
   - 自动检测连接的显示器（使用xrandr）
   - 解析显示器信息（分辨率、位置）
   - 虚拟屏幕配置（单显示器模式）

2. **浏览器管理**
   - 启动/停止浏览器实例
   - 窗口位置控制
   - 全屏/窗口模式切换
   - 浏览器生命周期管理

3. **屏幕控制**
   - 启动单个屏幕
   - 启动所有屏幕
   - 停止单个屏幕
   - 停止所有屏幕
   - 重启屏幕

4. **模式支持**
   - 单显示器模式（窗口模式）
   - 多显示器模式（全屏模式）

---

### 4. Express HTTP 服务器 (`backend/server.js`)

**功能：** 提供REST API和静态文件服务

#### ✅ 已实现功能

1. **REST API**
   - 健康检查：`GET /api/health`
   - ROS2状态：`GET /api/ros2/status`
   - 屏幕状态：`GET /api/screens`
   - 屏幕控制：
     - `POST /api/screens/:screenId/start` - 启动屏幕
     - `POST /api/screens/:screenId/stop` - 停止屏幕
     - `POST /api/screens/:screenId/restart` - 重启屏幕

2. **静态文件服务**
   - 提供前端应用静态文件
   - SPA路由支持

3. **中间件**
   - CORS支持
   - JSON解析
   - 静态文件服务

4. **模块集成**
   - ROS2 Bridge ↔ WebSocket服务
   - WebSocket服务 ↔ 前端客户端
   - 屏幕管理 ↔ HTTP API

---

## 🔗 模块间通信

### 数据流图

```
┌─────────────┐
│ ROS2节点     │
└──────┬──────┘
       │ DDS
       ▼
┌─────────────┐
│rosbridge_   │
│suite        │
└──────┬──────┘
       │ WebSocket (ws://)
       ▼
┌─────────────────┐      ┌──────────────────┐
│ ROS2Bridge模块  │◄─────►│ WebSocketService │
│                 │       │                  │
│ - 订阅话题      │       │ - 客户端管理     │
│ - 发布消息      │       │ - 数据转发       │
│ - 调用服务      │       │ - 事件处理       │
└─────────────────┘      └────────┬─────────┘
                                   │ Socket.io
                                   ▼
                          ┌──────────────────┐
                          │ 前端应用         │
                          │ (React)          │
                          └──────────────────┘
```

---

## 🚀 ROS2 Bridge 通信能力

### ✅ 已支持的功能

1. **连接能力**
   - ✅ 连接本机ROS2 Bridge (`ws://localhost:9090`)
   - ✅ 连接远端ROS2 Bridge (`ws://IP:9090`)
   - ✅ 自动重连机制
   - ✅ 连接状态监控

2. **数据订阅**
   - ✅ 订阅ROS2话题
   - ✅ 接收话题数据
   - ✅ 自动转发到前端
   - ✅ 支持配置默认订阅话题

3. **数据发布**
   - ✅ 发布消息到ROS2话题
   - ✅ 支持前端触发发布
   - ✅ 消息格式转换

4. **服务调用**
   - ✅ 调用ROS2服务
   - ✅ 服务参数传递
   - ✅ 服务响应处理

### 📝 使用示例

#### 1. 连接本机ROS2 Bridge

```bash
# 启动rosbridge_server（在ROS2环境中）
ros2 run rosbridge_server rosbridge_websocket

# 配置环境变量（可选）
export ROS2_BRIDGE_URL=ws://localhost:9090

# 启动后端服务
npm start
```

#### 2. 连接远端ROS2 Bridge

```bash
# 在远端机器上启动rosbridge_server
ros2 run rosbridge_server rosbridge_websocket --port 9090

# 配置环境变量
export ROS2_BRIDGE_URL=ws://192.168.1.100:9090

# 启动后端服务
npm start
```

#### 3. 配置订阅话题

```bash
# 在.env文件中配置
ROS2_TOPICS=/robot/status,/robot/telemetry,/robot/commands

# 或通过环境变量
export ROS2_TOPICS=/robot/status,/robot/telemetry
```

---

## 🔍 状态检查

### 检查ROS2 Bridge连接状态

```bash
# 通过API检查
curl http://localhost:3000/api/ros2/status

# 响应示例
{
  "connected": true,
  "url": "ws://localhost:9090",
  "subscriptions": [
    "/robot/status",
    "/robot/telemetry"
  ],
  "reconnectAttempts": 0
}
```

### 检查整体健康状态

```bash
curl http://localhost:3000/api/health

# 响应示例
{
  "status": "ok",
  "timestamp": "2025-12-02T14:47:45.841Z",
  "modules": {
    "ros2Bridge": {
      "connected": true,
      "url": "ws://localhost:9090",
      "subscriptions": ["/robot/status"],
      "reconnectAttempts": 0
    },
    "screens": [...],
    "websocket": {
      "clients": 2
    }
  }
}
```

---

## ⚙️ 配置说明

### ROS2 Bridge配置 (`backend/config/index.js`)

```javascript
ros2Bridge: {
  // WebSocket地址（支持本机和远端）
  url: process.env.ROS2_BRIDGE_URL || 'ws://localhost:9090',
  
  // 重连配置
  reconnect: {
    enabled: true,        // 启用自动重连
    interval: 3000,       // 重连间隔（毫秒）
    maxAttempts: 10,     // 最大重连次数
  },
  
  // 默认订阅的话题列表
  topics: [
    '/robot/status',
    '/robot/telemetry',
    '/robot/commands',
  ],
}
```

---

## 🎯 总结

### Backend实现的核心功能

1. ✅ **ROS2通信** - 完整的rosbridge_suite集成
2. ✅ **WebSocket服务** - 实时双向通信
3. ✅ **屏幕管理** - 多屏显示控制
4. ✅ **REST API** - HTTP接口服务
5. ✅ **模块解耦** - 清晰的架构设计

### ROS2 Bridge通信能力

- ✅ **支持本机连接** - `ws://localhost:9090`
- ✅ **支持远端连接** - `ws://IP:9090` 或 `ws://hostname:9090`
- ✅ **自动重连** - 网络断开后自动恢复
- ✅ **完整功能** - 订阅、发布、服务调用

### 当前状态

系统已经**完全支持**与本机或远端的ROS2 Bridge通信，只需要：
1. 确保rosbridge_server正在运行
2. 配置正确的WebSocket URL
3. 启动后端服务

系统会自动连接、订阅话题、转发数据到前端！

