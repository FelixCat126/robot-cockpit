# 3D机器人可视化功能测试指南

## 功能概述

本次实现在单屏和多屏模式下集成了Three.js 3D人形机器人可视化功能：

- **单屏模式**：视频区域左上角显示320x180px的3D机器人小窗口
- **多屏模式**：新增Screen3（第4个屏幕）专门显示640x1000px的3D机器人可视化
- **动画效果**：3D人形机器人持续执行走路动画，相机自动旋转

## 已完成的工作

### 1. 核心组件创建
- ✅ `HumanoidRobotGenerator.ts` - 人形机器人模型生成器
- ✅ `WalkingAnimation.ts` - 走路动画控制器
- ✅ `Robot3DViewer.tsx` - 3D可视化组件

### 2. 后端配置更新
- ✅ 修改 `backend/config/index.js` 支持4个屏幕（0-3）

### 3. 前端集成
- ✅ 修改 `Screen3.tsx` 实现3D机器人显示
- ✅ 修改 `MultiScreenLayout.tsx` 添加Screen3路由
- ✅ 修改 `SingleScreenLayout.tsx` 添加3D小窗口
- ✅ 添加CSS样式到 `SingleScreenLayout.css` 和 `Screen.css`

### 4. 错误处理与性能优化
- ✅ WebGL支持检测
- ✅ 加载状态指示器
- ✅ 错误降级方案
- ✅ 资源清理机制
- ✅ 性能优化（像素比限制、阴影优化）

## 测试步骤

### 一、单屏模式测试

#### 1. 启动单屏模式服务
```bash
# 确认配置
export DISPLAY_MODE=single

# 或直接在 backend/config/index.js 中确认：
# mode: process.env.DISPLAY_MODE || 'single'

# 启动服务
cd /Users/Felix/robot-cockpit
node backend/server.js
```

#### 2. 验证登录流程
- [ ] 浏览器自动打开并显示登录页面
- [ ] 输入用户名密码登录成功
- [ ] 登录后显示机器人选择页面

#### 3. 选择机器人后验证
- [ ] 视频区域左上角显示3D机器人小窗口（320x180px）
- [ ] 3D机器人正在执行走路动画
- [ ] 相机自动旋转显示不同角度
- [ ] 小窗口有绿色边框和阴影效果
- [ ] 小窗口不遮挡关键视频内容

#### 4. 验证现有功能正常
- [ ] 控制面板按钮可以点击
- [ ] 状态监控正常显示
- [ ] 音频可视化正常工作
- [ ] 更换机器人功能正常
- [ ] 退出登录功能正常

#### 5. 性能检查
- [ ] 打开Chrome DevTools > Performance
- [ ] 检查帧率（应 >30fps）
- [ ] 检查内存占用（应稳定）
- [ ] 长时间运行测试（10分钟）

### 二、多屏模式测试

#### 1. 切换到多屏模式
```bash
# 修改 backend/config/index.js
# mode: process.env.DISPLAY_MODE || 'multi'

# 或设置环境变量
export DISPLAY_MODE=multi

# 停止之前的服务
lsof -ti:3000 | xargs kill -9 2>/dev/null || true

# 重新启动服务
node backend/server.js
```

#### 2. 验证4个屏幕窗口启动
- [ ] 4个浏览器窗口自动打开
- [ ] Screen 0: 控制界面（左侧）
- [ ] Screen 1: 视频流界面（中间）
- [ ] Screen 2: 状态监控界面（右侧）
- [ ] Screen 3: 3D机器人可视化界面（新增）

#### 3. 验证Screen3初始状态
- [ ] Screen3显示登录页面或"等待选择机器人"提示
- [ ] 其他3个屏幕也处于相同状态

#### 4. 登录后验证
- [ ] 在Screen0登录后，Screen3自动切换到"等待选择机器人"
- [ ] 其他屏幕也同步切换状态

#### 5. 选择机器人后验证Screen3
- [ ] Screen3自动显示3D机器人可视化
- [ ] 标题显示"🤖 3D机器人可视化"
- [ ] 显示WebSocket连接状态
- [ ] 3D机器人正在执行走路动画
- [ ] 相机自动旋转
- [ ] 显示网格地面和坐标轴
- [ ] 背景为深蓝色渐变

#### 6. 验证联动机制
- [ ] 在Screen0注销，所有屏幕返回登录页
- [ ] 重新登录选择机器人，Screen3正确显示3D内容
- [ ] 更换机器人，Screen3保持显示并继续动画

#### 7. 窗口布局验证
- [ ] Screen3窗口大小正确（640x1000或配置的尺寸）
- [ ] Screen3窗口位置正确（第4个屏幕位置）
- [ ] 所有窗口不重叠

### 三、边界情况测试

#### 1. WebGL不支持场景
- [ ] 在不支持WebGL的浏览器中（如果有），显示友好错误提示
- [ ] 错误提示："您的浏览器不支持WebGL，无法显示3D内容"
- [ ] 单屏模式下，其他功能不受影响

#### 2. 资源清理测试
- [ ] 在Screen3刷新页面，3D场景正常重新加载
- [ ] 使用Chrome DevTools Memory检查，多次刷新后内存不持续增长
- [ ] 切换机器人或注销，3D资源正确释放

#### 3. 性能压力测试
- [ ] 多屏模式下，Screen3长时间运行（30分钟）
- [ ] 帧率保持稳定（>30fps）
- [ ] CPU占用合理（<20%）
- [ ] 内存占用稳定（<200MB）

### 四、视觉效果检查

#### 1. 3D机器人模型
- [ ] 机器人有头部（球形）
- [ ] 机器人有躯干（方形）
- [ ] 机器人有双臂（上臂+前臂）
- [ ] 机器人有双腿（大腿+小腿）
- [ ] 机器人有脚（方形）
- [ ] 机器人有眼睛（黑色小球）

#### 2. 走路动画
- [ ] 左右腿前后交替摆动
- [ ] 手臂与对侧腿同步摆动（右腿前左臂前）
- [ ] 膝盖弯曲自然
- [ ] 躯干轻微上下晃动
- [ ] 头部轻微点头
- [ ] 动画流畅无卡顿

#### 3. 场景效果
- [ ] 有环境光照（整体明亮）
- [ ] 有方向光照（产生阴影）
- [ ] 地面网格清晰可见
- [ ] 机器人投影到地面上
- [ ] 相机旋转平滑

#### 4. UI样式
- [ ] 单屏小窗口：绿色边框、半透明背景
- [ ] 多屏Screen3：标题清晰、状态指示器正常
- [ ] 加载状态：旋转圆圈动画
- [ ] 错误状态：红色警告图标和文字

## 已知限制

1. **无真实URDF**：当前使用程序生成的简化人形机器人模型
2. **无ROS2数据**：走路动画是固定模式，不基于真实关节状态
3. **性能影响**：3D渲染会增加一定GPU和CPU负载（已优化）
4. **浏览器兼容性**：需要支持WebGL的现代浏览器

## 文件清单

### 新建文件（4个）
1. `frontend/src/utils/HumanoidRobotGenerator.ts`
2. `frontend/src/utils/WalkingAnimation.ts`
3. `frontend/src/components/shared/Robot3DViewer.tsx`
4. `3D机器人可视化测试指南.md`（本文件）

### 修改文件（7个）
1. `backend/config/index.js` - 屏幕数量从3改为4
2. `frontend/package.json` - 添加Three.js依赖
3. `frontend/src/layouts/MultiScreenLayout.tsx` - 添加Screen3路由
4. `frontend/src/screens/Screen3.tsx` - 实现3D机器人显示
5. `frontend/src/layouts/SingleScreenLayout.tsx` - 添加3D小窗口
6. `frontend/src/layouts/SingleScreenLayout.css` - 3D小窗口样式
7. `frontend/src/screens/Screen.css` - Screen3样式

## 故障排查

### 问题1：3D窗口显示空白
**可能原因**：
- WebGL不支持
- 资源加载失败
- JavaScript错误

**解决方法**：
1. 打开浏览器开发者工具查看Console错误
2. 检查Three.js是否正确安装：`npm list three`
3. 确认前端已重新构建：`cd frontend && npm run build`

### 问题2：动画卡顿
**可能原因**：
- 性能不足
- 其他进程占用资源
- 渲染设置过高

**解决方法**：
1. 检查CPU和GPU使用率
2. 关闭其他占用资源的应用
3. 降低像素比率（已设置为最大2）

### 问题3：多屏模式Screen3未显示
**可能原因**：
- 配置中屏幕数量未更新
- 浏览器启动失败
- URL参数错误

**解决方法**：
1. 确认 `backend/config/index.js` 中 `multi.count` 为 4
2. 检查终端输出，确认4个屏幕都已启动
3. 手动访问 `http://localhost:3000?screen=3`

### 问题4：单屏模式3D窗口位置不对
**可能原因**：
- CSS样式冲突
- 浏览器缩放设置
- 窗口大小不标准

**解决方法**：
1. 检查浏览器缩放为100%
2. 清除浏览器缓存并刷新
3. 检查 `SingleScreenLayout.css` 中 `.robot-3d-overlay` 样式

## 后续扩展建议

1. **集成真实URDF**：从ROS2获取机器人模型
2. **真实关节数据**：订阅 `/joint_states` 话题驱动动画
3. **交互控制**：添加鼠标控制相机、暂停/播放等功能
4. **性能监控**：在UI上显示帧率和性能指标
5. **多种动画**：支持站立、跑步、跳跃等多种动作
6. **自定义机器人**：支持上传自定义3D模型

## 测试完成标准

✅ 单屏模式下3D小窗口正常显示并动画流畅  
✅ 多屏模式下Screen3正常显示并响应登录/选择机器人联动  
✅ 所有现有功能不受影响  
✅ 无明显性能问题和内存泄漏  
✅ 错误处理友好，降级方案有效

## 测试结果记录

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 单屏模式启动 | ⏳ 待测试 | |
| 单屏3D窗口显示 | ⏳ 待测试 | |
| 多屏模式启动 | ⏳ 待测试 | |
| Screen3正常显示 | ⏳ 待测试 | |
| 登录联动正常 | ⏳ 待测试 | |
| 走路动画流畅 | ⏳ 待测试 | |
| 现有功能正常 | ⏳ 待测试 | |
| 性能达标 | ⏳ 待测试 | |
| 错误处理正常 | ⏳ 待测试 | |

---

测试完成后，请在此文件中记录测试结果和发现的问题。

